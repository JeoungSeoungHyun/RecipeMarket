<!DOCTYPE html>
<html lang="en">

<head>
    <title>Bootstrap Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .my_profile_rounded_img {
            width: 100px;
            height: 100px;
            border-radius: 50px;
        }
    </style>

</head>
 
<body>
    <h2>회원가입 페이지</h2>
    <div class="container d-flex">
        <!-- 프로필  -->
        <div class="">
            <img src="https://i1.sndcdn.com/avatars-000373392764-zp0p80-t500x500.jpg" class="my_profile_rounded_img"
                id="profile-img-btn">
            <form id="fileForm" enctype="multipart/form-data">
                <input type="file" class="my_hidden" id="profile-img-input" name="profileImgFile"/>
            </form>
        </div>
        <!-- 회원가입 -->
        <div>
            <form action="/join" method="post">
                <div class="form-group">
                    <input type="text" class="form-control" id="username" placeholder="Enter username" name="username">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" id="nickname" placeholder="Enter nickname" name="file">
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="password" placeholder="Enter password"
                        name="password">
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="password-check" placeholder="Enter password"
                        name="password-check">
                </div>
                <div class="form-group">
                    <input type="email" class="form-control" id="email" placeholder="Enter email" name="email">
                </div>
                <button type="submit" class="btn btn-primary">회원가입</button>
            </form>
        </div>

    </div>

    <script>
        $("#profile-img-btn").click(() => {
            $("#profile-img-input").click();
        });

        $("#profile-img-input").change((event) => {
            profileImgUpdate(event);
        }); // 파일을 선택하면!!

        async function profileImgUpdate(event) {
            // image/png 이런식의 파일임.
            let f = event.target.files[0];
            if (!f.type.match("image.*")) {
                alert("이미지를 선택해주세요!");
                return;
            }

            // Multipart File => header 가 필요 없음
            // multipart/form-data 로 파일을 전송하는 것이 가장 편하다.
            // form 태그 자바스크립트 객체 찾기 => fileForm
            // form 태그 key:value 데이터 변환 => formData
            let fileForm = $("#fileForm")[0];
            let formData = new FormData(fileForm);
            let response = await fetch(`/join/profile-img`, {
                method: "put",
                body: formData
            });

            if (response.status == 200) {
                imgPreview(event, f);
            } else {
                alert("프로파일 변경에 실패하였습니다");
            }
        }
        function imgPreview(event, f) {
            let reader = new FileReader();
            // 콜백 (파일 이미지가 객체화 되면!!)
            reader.onload = (event) => {
                //console.log(event.target.result);
                $("#profile-img-btn").attr("src", event.target.result);
            }
            reader.readAsDataURL(f); // 비동기 실행(I/O)
        }
    </script>

</body>

</html>